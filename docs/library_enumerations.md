# Library Enumerations
eDESIGNER enumerates libraries by attachingbuilidng blocks that have been previously prepared by preparation reactions in such a way that the bonds are formed by joining atoms containing the same isotopic label.

The process of ensambling the library is done through a class named graph_enumerator. It is effecient because it uses LillyMol to atach fragments and is amenable for paralelization in an HPC cluster. In our tests we have run enumerations of libraries of 300 million compounds in 3 minutes.

The efficiency in the enumeration is done at a cost of a complex algorithm to prepare building blocks when library topologies are complex (for example, reactions that give rise to FGs that are then deprotected and take part in another reaction). This preparations are pre-coded and, although tests have been run to ensure that most posibilities are covered, there is not guaraty that all of them are covered.

The enumeration of libraries is conducted by the script run_enumerate_library.sh. Running the script with argument -h gives a summary of the available arguments. 

If the library was generated by eDESIGNER, wfolder, run_id and ed_run id are required arguments so the script can find the library definitions of a specific eDESIGNER run. Also either lib_id or lib_idx are required to identify the appropriate library. BBs can be selected from the eDESIGNER selection (default) or custom BB files passed through bbs_file argument. 

If the enumerations to be made is not coming from an eDESIGNER run, then arguments u (indicating it is a user library) and lib_id (with the library token) are required. To learn how to produce a lib_id token see file [how_to_generate_a_lib_id](./how_to_generate_a_lib_id.md)

In both cases the enumeration run produces a folder containing the enumeration file, the prepared BB files, and a number of reports indicating the BBs that were not compatible with the enumeration and a sequence of reactions used during the enumeration.

## Coding new reactions

New reactions can be coded by updating the files reaction.par, deprotection.par, enum_reaction.par and enum_deprotection.par. 

Reactions are coded by indicating a reaction name and four tuples. The first tuple is the index of the FGs required for the reaction, one coming from the growing intermediate design and the other from the incoming BBT. The second tuple codes the index of the FGs created by the reaction. The third tuple are the indexes of the FGs incomatible with the growing design intermediate for this design, and the fourth one is the list of indexes for incompatible FGs in the incoming BBT. Deprotections are coded the same way but the incompatibles with the incoming BBT are not included since there is not incoming BBT in deprotection reactions.

Reactions are grouped using an index. Names for these indexes are stored in enum_reaction.par or enum_deprotection.par files. Enum_reactions have not LillyMol rxn files associated, enum deprotections have, and they are stored in teh folder deprotections.

New functional groups can be added if necessary to the file fg.par. These FGs are associated with Lillyol query files in folder queries.

Description of LillyMol query and reaction files are beyond the scope of this documentation. The reader is encouraged to consult the LillyMol documentation and look into the examples in the repo.

## Coding reaction sequences and BB preparations

When new reactions are added, or when a specific library does not enumerate because there is a missing sequence in the multireaction.par file, it is required to add this sequence and maybe also new preparation reactions.

The simplest sequence is a single reaction acting on functional groups coming from a BBT that was incorporated before to the growing design and an incoming BBT. For example a reductive amination reaction would have a sequence coded in the multireaction.par file such this:

s_reactions= r1, out_isotopes=0, bond_orders=1, cycle_bond_order=0, preparations=1;5

This sequence codes a single reaction r1 which is the reductive amination. The output FG of the reaction will have no isotopes (out_isotopes=0) since it will not react further. The bond order for the bond formed is 1. Since no further bonds (cyclization bonds) are generated, the cycle_bond order is set to 0 and the preparation reactions used to prepare the BBs are preparation 1 (which converts the aldeyde into a methyl group with an isotopic label) and preparation 5 (wich adds the same isotopic label to the nitrogen of the amine)

Whenever a functional group is created in one reaction and is used later in another reaction (maybe with deprotections in the middle) a more complex sequence has to be used. One exapmle is the following:

s_reactions= r1;r14, out_isotopes=2, bond_orders=1;1, cycle_bond_order=0, preparations=1;6;24

In this case the first reductive amination reaction r1 produces a secondary amine functional group and this functional group is not carried by any BBT but generated by a reaction. This FG is then used by a second reaction, a sulphonylation by an sulphonyl halide. Since the amine FG was not carried originally by a BBT but created in a previous reaction, the sequence must be explicitly coded. In this case the first reaction produces a functional group and its atom is marked with isotope 2 (out_isotopes=2) since it will react later in the sequence. This sequence creates atwo bonds, each one of order 1 (bond_orders=1;1) and there are no cyclic bonds formed. Since the sequence has two reactions it involves 3 BB preparations and the preparation reactions are indexed as 1, 6 and 24. The praparation 1 was already described. The preparation 6 is the same as 5 but only applies to primary amines and creates a new isotope in the amine nitrogen. The enumeration engine will know that the N of the amine starts with isotope 1 but ends in this case with isotope 2 because the out_isotopes=2, the preparation 24 prepares the sulphonyl halide by removing the halide and puting isotope 2 in the sulphur atom so it can be attached to the original nitrogen of the amine in the second BB.

An even more comples scenari is in the following example:

s_reactions= r1;d11;r25, out_isotopes=0, bond_orders=1;1, cycle_bond_order=1, preparations=1;43;18

In this sequence there are two reactions plus an intermediate deprotection. The first reaction is the reductive amination that creates a new FG (a secondary amine), then the amine is reacted to form a guanidine using enum_deprotection of index 11, once the guanidine is formed it reacts with an alpha-bromo ketone to give an imidazole using reaction 25. In this case the aldehyde is converted into the reactive species by preparation 1, the primary amine is converted into a guanidine that will have trhee isotopes, one in each nitrogen using preparation 43, the first isotope will be used to attach the amine to the aldehyde and the other two to react with the prepared bromo-ketone. Since a cycle is formed in this case the cycle_nond_order is set to 1 and since two main single bonds are used bond_ordes is set to 1;1. The preparation 18 prepares the bromoketone with two isotopes complementary to the ones in the amidine that will be used to form the cycle.

All preparation reactions are indexed in file preparations.par and are linked to LillyMol preparation reaction. Some sequences could be added using the already existing preparations but if new praparations are needed, the associated preparation reactions has to be coded as well.

Depiction of the preparation reactions included in the parameters of this repo are summarized in file [preparations](./preparations.md)


